<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEAD//CHAT</title>
<style>
:root {
  --bg:     #0a0e12;
  --bg2:    #111820;
  --bg3:    #1a2332;
  --teal:   #2dd4bf;
  --teal2:  #1a8a7a;
  --text:   #e2e8f0;
  --muted:  #64748b;
  --sys:    #475569;
  --red:    #f87171;
  --border: #1e3a4a;
  --font:   'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  height: 100dvh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ── Nick modal ── */
#nick-screen {
  position: fixed; inset: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
#nick-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 2rem 2.5rem;
  width: min(400px, 92vw);
  text-align: center;
}
#nick-box .logo { font-size: 1.6rem; font-weight: 700; color: var(--teal); letter-spacing: .15em; }
#nick-box .sub  { color: var(--muted); font-size: .75rem; margin: .5rem 0 1.5rem; letter-spacing: .1em; }
#nick-box label { display: block; color: var(--teal); font-size: .7rem; letter-spacing: .15em; text-transform: uppercase; margin-bottom: .5rem; text-align: left; }
#nick-input {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
  font-family: var(--font);
  font-size: .95rem;
  padding: .65rem .75rem;
  outline: none;
  margin-bottom: 1rem;
  transition: border-color .2s;
}
#nick-input:focus { border-color: var(--teal2); }
#nick-btn {
  width: 100%;
  background: var(--teal);
  color: var(--bg);
  border: none; border-radius: 4px;
  font-family: var(--font);
  font-size: .85rem;
  font-weight: 700;
  letter-spacing: .1em;
  text-transform: uppercase;
  padding: .7rem;
  cursor: pointer;
  transition: background .2s;
}
#nick-btn:hover { background: #3ae8d0; }

/* ── Header ── */
header {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: .65rem 1.25rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-shrink: 0;
}
.logo { font-size: 1.1rem; font-weight: 700; color: var(--teal); letter-spacing: .15em; }
.logo span { color: var(--muted); }
.nick-badge {
  font-size: .72rem;
  color: var(--muted);
  letter-spacing: .08em;
}
.nick-badge strong { color: var(--teal); }
.user-count {
  margin-left: auto;
  font-size: .72rem;
  color: var(--muted);
  letter-spacing: .08em;
}
.user-count span { color: var(--teal); font-weight: 700; }
.conn-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--muted);
  flex-shrink: 0;
  transition: background .3s;
}
.conn-dot.online { background: var(--teal); box-shadow: 0 0 6px var(--teal); }
.conn-dot.error  { background: var(--red); }

/* ── Messages ── */
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem 1.25rem;
  display: flex;
  flex-direction: column;
  gap: .35rem;
  scroll-behavior: smooth;
}
#messages::-webkit-scrollbar { width: 5px; }
#messages::-webkit-scrollbar-track { background: transparent; }
#messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.msg {
  display: flex;
  gap: .6rem;
  align-items: baseline;
  animation: fadeIn .15s ease;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: none; } }

.msg-time  { color: var(--sys); font-size: .65rem; flex-shrink: 0; }
.msg-nick  { color: var(--teal); font-size: .8rem; font-weight: 700; flex-shrink: 0; min-width: 6ch; }
.msg-nick.me { color: #a78bfa; }
.msg-text  { color: var(--text); font-size: .88rem; line-height: 1.5; word-break: break-word; }
.msg.system .msg-nick { color: var(--sys); }
.msg.system .msg-text { color: var(--sys); font-style: italic; }

.history-divider {
  text-align: center;
  color: var(--sys);
  font-size: .65rem;
  letter-spacing: .1em;
  padding: .5rem 0;
  border-top: 1px solid var(--border);
  margin-bottom: .25rem;
}

/* ── Input bar ── */
#input-bar {
  border-top: 1px solid var(--border);
  background: var(--bg2);
  padding: .75rem 1.25rem .5rem;
  display: flex;
  flex-direction: column;
  gap: .35rem;
  flex-shrink: 0;
}
#input-row {
  display: flex;
  gap: .75rem;
}
#char-count {
  font-size: .62rem;
  color: var(--sys);
  text-align: right;
  padding-right: .25rem;
  min-height: 1em;
  transition: color .15s;
}
#char-count.warn  { color: #f59e0b; }
#char-count.limit { color: var(--red); }
#msg-input {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
  font-family: var(--font);
  font-size: .9rem;
  padding: .6rem .75rem;
  outline: none;
  transition: border-color .2s;
}
#msg-input:focus { border-color: var(--teal2); }
#send-btn {
  background: var(--teal);
  color: var(--bg);
  border: none; border-radius: 4px;
  font-family: var(--font);
  font-size: .8rem;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  padding: .6rem 1.2rem;
  cursor: pointer;
  transition: background .2s;
  white-space: nowrap;
}
#send-btn:hover { background: #3ae8d0; }
#send-btn:disabled { background: var(--muted); cursor: not-allowed; }
</style>
</head>
<body>

<!-- Nick modal -->
<div id="nick-screen">
  <div id="nick-box">
    <div class="logo">☠ DEAD<span>//</span>CHAT</div>
    <div class="sub">transit encrypted (TLS) · ephemeral · zero persistence</div>
    <label for="nick-input">Callsign</label>
    <input id="nick-input" type="text" maxlength="24" placeholder="e.g. Ensign Wesley" autocomplete="off" spellcheck="false">
    <button id="nick-btn">Establish Connection</button>
  </div>
</div>

<!-- Main UI -->
<header>
  <div class="logo">☠ DEAD<span>//</span>CHAT</div>
  <div class="nick-badge">signed in as <strong id="my-nick-display">—</strong></div>
  <div class="user-count"><span id="user-count">0</span> online</div>
  <div class="conn-dot" id="conn-dot"></div>
</header>

<div id="messages"></div>

<div id="input-bar">
  <div id="input-row">
    <input id="msg-input" type="text" maxlength="1000" placeholder="Message..." autocomplete="off" spellcheck="false" disabled>
    <button id="send-btn" disabled>Send</button>
  </div>
  <div id="char-count"></div>
</div>

<script>
(function () {
  'use strict';

  // ── State ──────────────────────────────────────────────────────────────────
  let ws = null;
  let myNick = '';
  let connected = false;
  let reconnectTimer = null;
  let reconnectDelay = 1000;
  const MAX_RECONNECT = 30000;

  // ── DOM ────────────────────────────────────────────────────────────────────
  const nickScreen  = document.getElementById('nick-screen');
  const nickInput   = document.getElementById('nick-input');
  const nickBtn     = document.getElementById('nick-btn');
  const msgList     = document.getElementById('messages');
  const msgInput    = document.getElementById('msg-input');
  const sendBtn     = document.getElementById('send-btn');
  const connDot     = document.getElementById('conn-dot');
  const userCount   = document.getElementById('user-count');
  const myNickDisp  = document.getElementById('my-nick-display');
  const charCount   = document.getElementById('char-count');

  // ── Nick screen ────────────────────────────────────────────────────────────
  nickInput.focus();
  nickInput.addEventListener('keydown', e => { if (e.key === 'Enter') join(); });
  nickBtn.addEventListener('click', join);

  function join() {
    const raw = nickInput.value.trim();
    if (!raw) { nickInput.focus(); return; }
    myNick = raw;
    nickScreen.style.display = 'none';
    connect();
  }

  // ── WebSocket ──────────────────────────────────────────────────────────────
  function wsUrl() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const nick  = encodeURIComponent(myNick);
    return `${proto}//${location.host}/chat/ws?nick=${nick}`;
  }

  function connect() {
    if (ws) { try { ws.close(); } catch {} }
    setDot('connecting');

    ws = new WebSocket(wsUrl());

    ws.addEventListener('open', () => {
      connected = true;
      reconnectDelay = 1000;
      setDot('online');
      setInput(true);
      clearTimeout(reconnectTimer);
    });

    ws.addEventListener('message', e => {
      let msg;
      try { msg = JSON.parse(e.data); } catch { return; }
      handleMessage(msg);
    });

    ws.addEventListener('close', () => {
      connected = false;
      setDot('error');
      setInput(false);
      scheduleReconnect();
    });

    ws.addEventListener('error', () => {
      setDot('error');
    });
  }

  function scheduleReconnect() {
    clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(() => {
      appendSystem(`Reconnecting…`);
      connect();
    }, reconnectDelay);
    reconnectDelay = Math.min(reconnectDelay * 2, MAX_RECONNECT);
  }

  // ── Message handling ───────────────────────────────────────────────────────
  let historyShown = false;

  function handleMessage(msg) {
    switch (msg.type) {
      case 'identity':
        myNick = msg.nick;
        myNickDisp.textContent = myNick;
        break;

      case 'history':
        if (msg.messages && msg.messages.length > 0) {
          appendDivider(`── last ${msg.messages.length} messages ──`);
          msg.messages.forEach(renderMsg);
          appendDivider(`── live ──`);
        }
        historyShown = true;
        break;

      case 'message':
        renderMsg(msg);
        break;

      case 'system':
        appendSystem(msg.text);
        if (typeof msg.count === 'number') userCount.textContent = msg.count;
        break;

      case 'count':
        userCount.textContent = msg.count;
        break;
    }
  }

  function renderMsg(msg) {
    if (msg.type === 'system') { appendSystem(msg.text); return; }
    const isMe = msg.nick === myNick;
    const el = document.createElement('div');
    el.className = 'msg';

    const time = document.createElement('span');
    time.className = 'msg-time';
    time.textContent = formatTime(msg.ts);

    const nick = document.createElement('span');
    nick.className = 'msg-nick' + (isMe ? ' me' : '');
    nick.textContent = msg.nick;

    const text = document.createElement('span');
    text.className = 'msg-text';
    text.textContent = msg.text;

    el.appendChild(time);
    el.appendChild(nick);
    el.appendChild(text);
    appendEl(el);
  }

  function appendSystem(text) {
    const el = document.createElement('div');
    el.className = 'msg system';

    const time = document.createElement('span');
    time.className = 'msg-time';
    time.textContent = formatTime(Date.now());

    const nick = document.createElement('span');
    nick.className = 'msg-nick';
    nick.textContent = '—';

    const t = document.createElement('span');
    t.className = 'msg-text';
    t.textContent = text;

    el.appendChild(time);
    el.appendChild(nick);
    el.appendChild(t);
    appendEl(el);
  }

  function appendDivider(text) {
    const el = document.createElement('div');
    el.className = 'history-divider';
    el.textContent = text;
    appendEl(el, false);
  }

  function appendEl(el, scroll = true) {
    msgList.appendChild(el);
    if (scroll) {
      const atBottom = msgList.scrollHeight - msgList.clientHeight - msgList.scrollTop < 80;
      if (atBottom) msgList.scrollTop = msgList.scrollHeight;
    }
  }

  // ── Character counter ──────────────────────────────────────────────────────
  msgInput.addEventListener('input', () => {
    const len = msgInput.value.length;
    if (len === 0) {
      charCount.textContent = '';
      charCount.className = '';
    } else {
      charCount.textContent = `${len} / 1000`;
      charCount.className = len > 980 ? 'limit' : len > 800 ? 'warn' : '';
    }
  });

  // ── Send ───────────────────────────────────────────────────────────────────
  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  sendBtn.addEventListener('click', sendMessage);

  function sendMessage() {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    const text = msgInput.value.trim();
    if (!text) return;
    ws.send(JSON.stringify({ type: 'message', text }));
    msgInput.value = '';
    charCount.textContent = '';
    charCount.className = '';
    msgInput.focus();
  }

  // ── Helpers ────────────────────────────────────────────────────────────────
  function setDot(state) {
    connDot.className = 'conn-dot' + (state === 'online' ? ' online' : state === 'error' ? ' error' : '');
  }

  function setInput(enabled) {
    msgInput.disabled = !enabled;
    sendBtn.disabled  = !enabled;
    if (enabled) msgInput.focus();
  }

  function formatTime(ts) {
    const d = new Date(ts);
    const h = String(d.getHours()).padStart(2, '0');
    const m = String(d.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  }
})();
</script>
</body>
</html>
